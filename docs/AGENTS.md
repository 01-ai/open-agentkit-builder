# Open Agent Builder - 项目记忆库

## 项目概述

复刻 OpenAI AgentBuilder - 一个可视化工作流智能体构建平台

## AI 协作规范

**重要原则：永远不要多做！**

- ❌ 不要擅自实现额外功能
- ❌ 不要猜测用户需求
- ✅ 有任何疑问时，先询问用户
- ✅ 给出计划或建议，等用户确认后再行动
- ✅ 只做用户明确要求的事情

**语言规范**

- 💬 **交流语言**：使用中文（用户母语，方便沟通）
- 💻 **代码语言**：优先使用英文
  - 变量名、函数名、类名使用英文
  - 代码注释使用英文
  - UI 文本（按钮、标签、提示等）使用英文
  - API 响应消息使用英文
  - 只有特定需求时才使用中文（如面向中文用户的内容）

## 技术选型

### 核心技术栈

- **框架**: Next.js 15+ (App Router 模式)
- **包管理器**: **pnpm** (强制要求)
- **语言**: TypeScript
- **UI 组件库**: shadcn/ui
- **画布库**: React Flow (xyflow)
- **样式**: Tailwind CSS
- **数据存储**: 本地文件数据库 (JSON/lowdb)

### 设计理念

- 快速原型迭代
- 面向开源
- 简单易用
- 节点设计怎么容易怎么来

## 开发阶段

### 第一阶段 - 技术选型和基础架构 ✅ (已完成)

- [x] 初始化 Next.js 项目
- [x] 配置 pnpm 包管理
- [x] 安装 shadcn/ui
- [x] 安装 React Flow
- [x] 配置本地文件数据库
- [x] 搭建基础项目结构

### 第二阶段 - UI 和工作流编排 ✅ (已完成)

- [x] 设计主界面布局
- [x] 实现工作流列表页面
- [x] 实现画布编辑器页面
- [x] 实现节点类型系统
- [x] 实现节点配置面板
- [x] 实现工作流保存/加载

### 当前状态 ✅

**项目已完成基础搭建，可以正常运行！**

运行命令：

```bash
pnpm dev
```

访问 http://localhost:3000 即可开始使用。

查看 [QUICKSTART.md](./QUICKSTART.md) 了解详细使用说明。

### 第三阶段 - 节点能力扩展（未来）

- [ ] LLM 节点
- [ ] 条件判断节点
- [ ] 循环节点
- [ ] 用户审批节点
- [ ] 文件检索节点
- [ ] 数据转换节点

### 第四阶段 - AI 能力集成（未来）

- [ ] OpenAI API 集成
- [ ] 工作流执行引擎
- [ ] 实时执行状态展示

## 项目规范

### 包管理

- **必须使用 pnpm**
- 不使用 npm 或 yarn

### 代码风格

- TypeScript 严格模式
- 组件优先使用函数式组件
- 使用 App Router 约定的文件结构
- **Prettier** 统一代码格式
- **保存时自动格式化**（已配置）
- **不使用分号**（代码风格规则）

### 代码格式化

项目已配置 Prettier 和 ESLint 集成：

- ✅ Prettier 配置（`.prettierrc`）
- ✅ ESLint 集成 Prettier
- ✅ 保存时自动格式化（`.vscode/settings.json`）
- ✅ EditorConfig 配置（`.editorconfig`）

**可用命令：**

```bash
pnpm format        # 格式化所有文件
pnpm format:check  # 检查格式
pnpm lint:fix      # 修复 ESLint 错误
```

## 项目结构

```
open-agent-builder/
├── app/
│   ├── api/
│   │   └── workflows/          # 工作流 API 路由
│   ├── workflow/[id]/          # 工作流编辑器页面
│   ├── layout.tsx              # 根布局
│   └── page.tsx                # 工作流列表页面
├── components/
│   └── ui/                     # shadcn UI 组件
├── lib/
│   ├── db.ts                   # 本地文件数据库
│   ├── node-templates.ts       # 节点模板定义
│   └── utils.ts                # 工具函数
├── types/
│   └── workflow.ts             # 工作流类型定义
└── data/                       # 本地数据存储（已加入 .gitignore）
```

## 功能特性

### 已实现

- ✅ 工作流列表展示和管理
- ✅ 创建/删除工作流
- ✅ 可视化画布编辑器（基于 React Flow）
- ✅ 8 种节点类型（开始、LLM、条件、循环、审批、检索、转换、结束）
- ✅ 节点拖拽添加
- ✅ 节点连线
- ✅ 工作流保存/加载
- ✅ 本地文件数据库持久化

### 节点类型

- 🎬 开始节点
- 🤖 LLM 调用节点
- 🔀 条件判断节点
- 🔄 循环节点
- ✋ 用户审批节点
- 🔍 文件检索节点
- ⚙️ 数据转换节点
- 🏁 结束节点

## 重要决策记录

### 2025-10-13

**画布节点碰撞防止功能开发**

实现了画布节点的智能布局和碰撞防止功能：

**核心功能：**

- ✅ 点击添加节点到画布中心，自动推开重叠节点
- ✅ 拖拽节点到重叠位置时禁止放置
- ✅ 多节点连锁推动，保持所有节点不重叠

**技术方案演进：**

1. 初版：递归推动 + forEach 遍历 → 导致位置更新混乱
2. 改进：迭代队列 + tempPositions Map → 仍有"乒乓效应"
3. 方案 C：多轮扫描 + 批量应用 → 简化逻辑但仍有边缘重叠
4. **最终方案**：AABB 碰撞检测 + 最小位移分离（游戏引擎标准算法）

**最终算法特性：**

- 使用 AABB (Axis-Aligned Bounding Box) 精确碰撞检测
- 计算穿透深度（Penetration Depth），选择最小位移轴
- 新节点固定在中心，智能推开周围节点
- 多轮迭代直到稳定，每轮批量应用所有位移
- 性能优秀，适合实时交互

**关键经验：**

- 避免在遍历过程中同步修改节点位置
- 使用位移累积（displacement accumulation）机制
- 选择合适的分离轴可以最小化移动距离
- 详细的日志对调试复杂算法至关重要

**代码位置：** `app/(canvas)/agent-builder/edit/components/canvas.tsx`

### 2025-10-11

- 确定使用 pnpm 作为唯一包管理器
- 确定使用本地文件数据库（JSON 文件），避免额外安装
- 第一阶段专注于 UI 和工作流编排
- AI 能力后续迭代
- 完成基础项目架构和核心功能
- 配置 Prettier + ESLint，支持保存时自动格式化

## 参考资料

- OpenAI AgentBuilder 功能：可视化拖拽、条件逻辑、循环节点、用户审批、文件检索、数据转换
- React Flow 文档: https://reactflow.dev/
- shadcn/ui 文档: https://ui.shadcn.com/

---

_本文档会随项目进展持续更新_
